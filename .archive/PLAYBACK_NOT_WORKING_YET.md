# ğŸ¬ Why Playback Isn't Working Yet

**Status:** âœ… **Play button now wired, but needs proxy videos**

---

## ğŸ” What You're Seeing

When you click the Play button on a clip:
- âŒ Nothing happens (or error)
- âŒ "No thumbnail" shown
- âŒ Video player doesn't open

---

## ğŸ¤” Why It's Not Working

### **Root Cause: Missing Proxy Videos**

The clips in your database don't have:
1. âŒ `proxyUrl` - The playback video URL
2. âŒ `thumbnailUrl` - The thumbnail image URL

These are generated by the **worker** when you export clips, but only if the feature flag is ON.

---

## ğŸ› ï¸ How to Fix It

### **Option 1: Enable Feature Flag** â­ **Recommended**

Turn on the in-page playback feature:

```bash
# In your .env file or environment
export FF_INPAGE_PLAYBACK=true

# Restart the API
cd apps/api
npm run dev
```

Then:
1. Export a clip (click Export button)
2. Worker will generate proxy video
3. `proxyUrl` and `thumbnailUrl` will be saved
4. Play button will work!

---

### **Option 2: Generate Proxy Videos Manually**

If you have existing clips without proxy videos:

```bash
# Run a script to regenerate proxy videos for all clips
cd workers
python scripts/regenerate_proxy_videos.py
```

*(Note: This script doesn't exist yet, but we can create it)*

---

### **Option 3: Test with Source Video** 

The code now falls back to the source video if no proxy URL exists. So clicking Play should open the full source video (not the clip).

This works but isn't ideal because:
- Shows full video, not just the clip
- No thumbnails
- Slower to load

---

## ğŸ¯ What Needs to Happen

### **Backend Flow:**

```
User clicks "Export" on clip
â†“
API calls worker: POST /v1/render/export
â†“
Worker processes video
â†“
IF FF_INPAGE_PLAYBACK=true:
  â”œâ”€ Generate proxy video (720p, CRF 23)
  â”œâ”€ Generate thumbnail (first frame)
  â”œâ”€ Upload to storage
  â””â”€ Save URLs to database
â†“
Clip now has proxyUrl and thumbnailUrl
â†“
Play button works!
```

---

## ğŸ“‹ Step-by-Step Fix

### **1. Enable the Feature Flag**

Edit `.env`:
```env
FF_INPAGE_PLAYBACK=true
```

### **2. Restart Services**

```bash
# Terminal 1: API
cd apps/api
npm run dev

# Terminal 2: Worker
cd workers
python main.py

# Terminal 3: Web
cd apps/web
npm run dev
```

### **3. Export a Clip**

1. Go to project page
2. Select a clip (checkbox)
3. Click "Export" button
4. Wait for export to complete

### **4. Check Database**

```sql
SELECT id, title, proxyUrl, thumbnailUrl 
FROM "Moment" 
WHERE proxyUrl IS NOT NULL;
```

You should see URLs populated!

### **5. Refresh Page**

Reload the project page. Now you should see:
- âœ… Thumbnails showing
- âœ… Play button works
- âœ… Video player opens
- âœ… Clip plays instantly

---

## ğŸ”§ Quick Test

Want to test if the wiring works? Try this:

### **Test with Existing Export:**

If you already have exported clips:

```typescript
// In browser console on project page
// Find a clip and manually set proxyUrl
const clip = clips[0];
clip.proxyUrl = exportVideoUrls[Object.keys(exportVideoUrls)[0]];
// Now click play - it should work!
```

---

## ğŸ“Š Current Status

| Component | Status | Notes |
|-----------|--------|-------|
| **Play Button** | âœ… Wired | Calls onClipPlay correctly |
| **VideoPlayer** | âœ… Ready | Opens when clip clicked |
| **ClipsGrid** | âœ… Ready | Displays clips in grid |
| **Proxy Generation** | â³ Pending | Needs FF_INPAGE_PLAYBACK=true |
| **Thumbnail Generation** | â³ Pending | Needs FF_INPAGE_PLAYBACK=true |
| **Database URLs** | âŒ Missing | No proxyUrl/thumbnailUrl yet |

---

## ğŸ¯ What I Just Fixed

### **Before (5 mins ago):**
- âŒ Play button didn't call onClipPlay
- âŒ ClipsGrid used internal state only
- âŒ VideoPlayer never opened

### **After (Now):**
- âœ… Play button calls onClipPlay prop
- âœ… Parent component handles playback
- âœ… VideoPlayer opens (but needs video URL)
- âœ… Falls back to source video if no proxy

---

## ğŸš€ Next Steps

### **Immediate:**
1. Enable `FF_INPAGE_PLAYBACK=true`
2. Restart services
3. Export a clip
4. Test playback

### **Short Term:**
1. Create script to regenerate proxy videos
2. Add progress indicator for proxy generation
3. Show "Generating preview..." message

### **Long Term:**
1. Generate proxies in background (don't wait for export)
2. Use HLS streaming instead of MP4
3. Add video quality selector

---

## ğŸ’¡ Why This Design?

### **Feature Flag Pattern:**

We use feature flags so you can:
- âœ… Deploy code safely (flag OFF)
- âœ… Test in staging (flag ON)
- âœ… Roll out gradually
- âœ… Roll back instantly (just turn flag OFF)

### **Proxy Videos:**

We generate separate proxy videos because:
- âœ… Faster loading (720p vs 4K)
- âœ… Smaller file size
- âœ… Optimized for web playback
- âœ… Don't need to load full source video

---

## ğŸ‰ Summary

**The wiring is done!** âœ…

Now you just need to:
1. Turn on the feature flag
2. Generate proxy videos
3. Playback will work perfectly!

---

**Want me to help you enable the feature flag and test it?** ğŸš€
